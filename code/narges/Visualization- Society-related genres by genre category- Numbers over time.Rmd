---
title: "FBS analysis"
output:
  html_notebook:
    code_folding: hide
    toc: yes
---

```{r setup,echo=F}
knitr::opts_knit$set(root.dir = here::here())
library(here)
source("/Users/azizinar/Documents/GitHub/vd17-analysis/code/common_basis.R", local = knitr::knit_global())
library(tidyverse)
library(gghsci)
library(gt)
p <- function(number) {
  return(format(number, scientific = FALSE, big.mark = ","))
}
pp <- function(percentage, accuracy = 0.01) {
  return(scales::percent(percentage, accuracy = accuracy))
}
```


```{r}
all_match <- read.csv(here("all_match.csv"))
all_match <- select (all_match, -c('X','full_name_vd17','normalized_year','field_number'))
all_match_subset <-  all_match%>%
  filter(
    field_code %in% c("028A", "028B", "028C"), # FBS GND has to appear in one of these fields
    is.na(role) | !role %in% c("ctb", "dte"), # normed role has to be unknown or not one of these
    is.na(role) | !(role == "oth" & field_code == "028C" & !is.na(role2) & str_detect(role2, "^Beiträger|^Mitwirkender")), # in field 028C, if role is other, role2 should not be one of these
    is.na(role2) | !str_detect(role2, !!!str_flatten(c(
      "^AdressatIn",
      "ErwähnteR",
      "GefeierteR",
      "Mitglied eines Ausschusses, der akademische Grade vergibt",
      "Normerlassende Gebietskörperschaft",
      "Praeses",
      "RespondentIn",
      "Sonstige Person, Familie und Körperschaft",
      "VerfasserIn eines Vorworts",
      "VerfasserIn von ergänzendem Text",
      "VerfasserIn von Zusatztexten",
      "VertragspartnerIn",
      "WidmendeR",
      "WidmungsempfängerIn",
      "ZensorIn"
    ), collapse = "|^"))
  )
```

```{r}
all_match_subset <- select(all_match_subset,-c('role'))
```

# Joining vd17_id with fbs_links_of_interest 
```{r}
fbs_links_of_interest_local <- fbs_links_of_interest_a %>%
  inner_join(fbs_metadata_a %>% select(GND,Member_number_new,First_name_new,Last_name_new,Society_name,DOB,DOD) %>% mutate(GND = str_c("gnd/", GND))) %>%
 inner_join(vd17_id_a) %>%
  mutate(member_number=Member_number_new,first_name=First_name_new,last_name=Last_name_new)%>%
  collect()

fbs_links_of_interest_local <- select (fbs_links_of_interest_local, c('record_number','vd17_id','member_number','first_name', 'last_name','role2','field_code'))

```
# Merging society-subset with all-matches
```{r}
fbs_links_of_interest_matches <- rbind(fbs_links_of_interest_local,all_match_subset)

fbs_links_of_interest_matches <- fbs_links_of_interest_matches %>%
  distinct()
```

# Identifying society-related genres
```{r}
genre_list1_a <- c("Lyrik","Lyric Poetry","Ballade","Elegie","Epigramm","Epikedeion","Figurengedicht","Gesangbuch","Lied","Kirchenlied","Liedersammlung")
genre_list1_b <- c("Drama","Theatre","Fastnachtspiel","Komödie","Märtyrerdrama","Schauspiel","Schwank","Tragödie")
genre_list1_c <- c("Epik","Prose","Anekdote","Autobiographie","Biographie","Epos","Erlebnisbericht","Erzählung","Erzählsammlung","Fabel","Märchen","Novelle","Reisebericht","Roman","Sage","Satire","Tagebuch","Verserzählung")
genre_list1_d <- c("Other Literature Related","Content Related","Schäferdichtung","Libretto","Erotische Literatur","Emblembuch","Porträtwerk","Theaterzettel","Content Neutral","Almanach","Anthologie","Kommentar:lit.","Rezension","Rezensionszeitschrift")
genre_list1_e <- c("Linguistic and Language","Grammatik","Konkordanz","Lexikon","Poetik","Rhetorik","Sprachführer","Wörterbuch","Epistolography","Briefsteller","Formularsammlung","Schreibmeisterbuch")
genre_list1_f <- c("Virtue, Civility and Ethics","Aphorismus","Anstandsliteratur","Enzyklopädie","Frauenliteratur","Fürstenspiegel","Hausväterliteratur","Jugendbuch","Kochbuch","Moralische Wochenschrift","Spiel","Sprichwortsammlung","Zitatensammlung")
genre_list1_g <- c("Other Society Related","Gesellschaftsschrift","Akademieschrift")
genre_list1_h <- c("Occasional Literature","Funeral Sermons","Leichenpredigt","Leichenpredigtsammlung","Festbeschreibung","Gelegenheitsschrift")
genre_list1_i <- c("German as a scientific language","History, Archaeology and related","Archäologie","Altertumskunde","Chronik","Genealogie","Wappenbuch","Botany, Zoology, Agriculture","Botanik","Gartenbau","Jagdliteratur","Landwirtschaft","Praktik","Pflanzenbuch","Tierbuch","Zoologie","Geography, Geology, Mineralogy, Mining","Bergbau","Geographie","Geologie","Mineralogie","Reiseführer","Topographie","Mathematics, Natural Sciences, Astronomy","Alchemie","Astronomie","Astrologie","Chemie","Physik","Akustik","Magnetismus","Mechanik","Optik","Geometrie","Mathematik","Medicine, Pharmacy","Anatomie","Arzneibuch","Chiromantie","Chirurgie","Gynäkologie","Medizin","Pharmakopöe","Physiognomie","Seuchenschrift","Tiermedizin","Architecture, Music, Arts","Musikbuch","Musiknoten","Architektur","Ornamentstich","Education","Pädagogik")
```
# Identifying society-unrelated genres
```{r}
genre_list2 <- c("Educational","Schul- und Hochschulschriften","Hochschulschrift","Dissertation","Dissertation:theol.","Dissertation:med.","Dissertation:jur.","Dissertation:phil.","Dissertationensammlung","Matrikel","Universitätsprogramm","Vorlesung","Vorlesungsverzeichnis","Jugendsachbuch","Rechenbuch","Schulbuch","Fibel","Lesebuch","Schulprogramm","Governmental","Amtsdruckschrift","Edikt","Gesetz","Gesetzesammlung","Kapitulation","Mandat","Privileg","Richtlinie","Verordnung","Vertrag","Other Governmental and Institutional","Regesten","Urkundenbuch","Judicial","Legal","Entscheidungssammlung","Fallsammlung","Konsiliensammlung","Konsilium","Satzung","Religious","Theological","Agende","Beichtspiegel","Bibel","Brevier","Gebet","Katechismus","Missale","Psalter","Rituale","Business","Mercantile","Anzeige","Subskriptionsanzeige","Meßrelation","Subskribentenliste","Verkaufskatalog","Antiquariatskatalog","Auktionskatalog","Buchhandelskatalog","Meßkatalog","Military","Festungsbau","Kriegskunde","General Works","Bericht","Brief","Briefsammlung","Regelsammlung","Statistik","Streitschrift","Streitschrift:polit.","Streitschrift:jur.","Streitschrift:theol.","Geldwesen")
```

```{r}
vd17_normalized_years_local <- vd17_normalized_years_a %>%
  collect()
```


```{r}
vd17_genres_local <- vd17_genres_a %>%
  collect()%>%
  filter(!(a %in% c(genre_list2)))%>%
  mutate(genre_full=a)%>%
  select(record_number,genre_full)

genre_cat1 <- vd17_genres_local%>%
  filter(grepl(paste(c(genre_list1_a,genre_list1_b,genre_list1_c,genre_list1_d,genre_list1_e,genre_list1_f,genre_list1_g,genre_list1_h,genre_list1_i),collapse="|"), genre_full))%>%
  select(record_number,genre_full)
```

```{r}
genres_fbs_society <- fbs_links_of_interest_matches %>%
  left_join(vd17_normalized_years_local, by = c("record_number")) %>%
  filter(normalized_year >= 1600, normalized_year <= 1700) %>%
  filter(nchar(normalized_year)==4)%>%
  inner_join(genre_cat1,by = c("record_number"))%>%
  select(record_number,normalized_year,vd17_id,genre_full)%>%
  mutate(genre_category = case_when(
    (grepl(paste(genre_list1_a, collapse="|"), genre_full)) ~ "Lyrik/Poetry",
    (grepl(paste(genre_list1_b, collapse="|"), genre_full)) ~ "Drama/Theatre",
    (grepl(paste(genre_list1_c, collapse="|"), genre_full)) ~ "Epik/Prose",
    (grepl(paste(genre_list1_d, collapse="|"), genre_full)) ~ "Other Literature Related",
    (grepl(paste(genre_list1_e, collapse="|"), genre_full)) ~ "Linguistic and Language",
    (grepl(paste(genre_list1_f, collapse="|"), genre_full)) ~ "Virtue, Civility and Ethics",
    (grepl(paste(genre_list1_g, collapse="|"), genre_full)) ~ "Other Society Related",
    (grepl(paste(genre_list1_h, collapse="|"), genre_full)) ~ "Occasional Literature",
    (grepl(paste(genre_list1_i, collapse="|"), genre_full)) ~ "German as a scientific language"
  ))%>%
  distinct()
```

# Visualization: Society-related genres by genre category: Numbers over time
```{r}
genres_fbs_society%>%
  ggplot(aes(x=normalized_year,fill=genre_category)) +
  geom_bar(width=1) +
  labs(fill=NULL) +
  ggtitle("Member Publications in Society-Related Genre Categories")+
  ylab("")+xlab("Year")+
  scale_x_continuous(breaks = seq(1000, 2000, by = 2)) +
  scale_y_continuous(breaks = seq(0, 500, by = 50)) +
  theme_hsci_discrete() +
  theme(legend.position="bottom")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  theme(plot.title = element_text(hjust = 0.5))
```
# Visualization: Society-related genres by genre category: Proportion over time

```{r}
genres_fbs_society_frequency <- genres_fbs_society%>%
  filter(!(is.na(genre_full)))%>%
  select(vd17_id,record_number,normalized_year,genre_full)%>%
  distinct(vd17_id,record_number,normalized_year,genre_full)%>%
  group_by(normalized_year) %>%
  count(genre_full)%>%
  arrange(desc(n))%>%
   mutate(genre_category = case_when(
    (grepl(paste(genre_list1_a, collapse="|"), genre_full)) ~ "Lyrik/Poetry",
    (grepl(paste(genre_list1_b, collapse="|"), genre_full)) ~ "Drama/Theatre",
    (grepl(paste(genre_list1_c, collapse="|"), genre_full)) ~ "Epik/Prose",
    (grepl(paste(genre_list1_d, collapse="|"), genre_full)) ~ "Other Literature Related",
    (grepl(paste(genre_list1_e, collapse="|"), genre_full)) ~ "Linguistic and Language",
    (grepl(paste(genre_list1_f, collapse="|"), genre_full)) ~ "Virtue, Civility and Ethics",
    (grepl(paste(genre_list1_g, collapse="|"), genre_full)) ~ "Other Society Related",
    (grepl(paste(genre_list1_h, collapse="|"), genre_full)) ~ "Occasional Literature",
    (grepl(paste(genre_list1_i, collapse="|"), genre_full)) ~ "German as a scientific language"
  ))%>%
  distinct()

genres_fbs_society_frequency%>%
  ggplot(aes(x=normalized_year,y=n,fill=genre_category)) +
  geom_col(width=1,position='fill')+
  labs(fill=NULL) +
  ggtitle("Member Publications in Society-Related Genres")+
  ylab("")+xlab("Year")+
  scale_x_continuous(breaks = seq(1000, 2000, by = 2))+
  scale_y_continuous(labels=scales::percent_format(accuracy=1),breaks = seq(0, 1, by = 0.1)) +
  theme_hsci_discrete()+
  theme(legend.position = "bottom")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  theme(plot.title = element_text(hjust = 0.5))
```
```{r}
vd17_normalized_langs_local <- vd17_normalized_langs_a %>%
  collect()%>%
  filter(publication_language=="ger")
```

# Visualization: Overall output of Society members in German: Numbers over time
```{r}
fbs_society_german <- fbs_links_of_interest_matches %>%
  inner_join(vd17_normalized_langs_local, by=c("record_number"))%>%
  left_join(vd17_normalized_years_local, by = c("record_number")) %>%
  filter(normalized_year >= 1600, normalized_year <= 1700) %>%
  filter(nchar(normalized_year)==4)%>%
  select(record_number,normalized_year,vd17_id)%>%
  group_by(normalized_year) %>%
  summarize(records = n_distinct(record_number), .groups = "drop") %>%
  mutate(phase = case_when(
    normalized_year < 1617 ~ "< 1617",
    normalized_year >= 1617 & normalized_year <= 1650 ~ "phase 1",
    normalized_year >= 1651 & normalized_year <= 1667 ~ "phase 2",
    normalized_year >= 1668 & normalized_year <= 1682 ~ "phase 3",
    normalized_year > 1682 ~ "> 1682"
  ))%>%
  distinct()

group.colors <- c("< 1617" = "grey", "phase 1" = "cyan", "phase 2" ="#9633FF", "phase 3" = "pink", "> 1682" = "grey")
fbs_society_german%>%
  ggplot(aes(x=normalized_year, y=records, fill = phase)) + 
  geom_col()+
  xlab("Year") + ylab("")+
  ggtitle("Member Publications in German")+
  scale_x_continuous(breaks = seq(1000, 2000, by = 2))+
  scale_y_continuous(breaks = seq(0, 500, by = 50))+
  theme_hsci_discrete()+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_manual(values=group.colors)

```
# Visualization: Comparison with VD17: Society-related genre categories
```{r}
vd17_local_id <- vd17_id_a%>%
  collect()

genres_vd17_society <- vd17_local_id %>%
  inner_join(vd17_normalized_langs_local, by=c("record_number"))%>%
  left_join(vd17_normalized_years_local, by = c("record_number")) %>%
  filter(normalized_year >= 1600, normalized_year <= 1700) %>%
  filter(nchar(normalized_year)==4)%>%
  inner_join(genre_cat1,by = c("record_number"))%>%
  select(record_number,normalized_year,vd17_id,genre_full)%>%
  mutate(genre_category = case_when(
    (grepl(paste(genre_list1_a, collapse="|"), genre_full)) ~ "Lyrik/Poetry",
    (grepl(paste(genre_list1_b, collapse="|"), genre_full)) ~ "Drama/Theatre",
    (grepl(paste(genre_list1_c, collapse="|"), genre_full)) ~ "Epik/Prose",
    (grepl(paste(genre_list1_d, collapse="|"), genre_full)) ~ "Other Literature Related",
    (grepl(paste(genre_list1_e, collapse="|"), genre_full)) ~ "Linguistic and Language",
    (grepl(paste(genre_list1_f, collapse="|"), genre_full)) ~ "Virtue, Civility and Ethics",
    (grepl(paste(genre_list1_g, collapse="|"), genre_full)) ~ "Other Society Related",
    (grepl(paste(genre_list1_h, collapse="|"), genre_full)) ~ "Occasional Literature",
    (grepl(paste(genre_list1_i, collapse="|"), genre_full)) ~ "German as a scientific language"
  ))%>%
  distinct()

genres_vd17_society%>%
  ggplot(aes(x=normalized_year,fill=genre_category)) +
  geom_bar(width=1) +
  labs(fill=NULL) +
  ggtitle("Seventeenth-Century Publications in Society-Related Genres")+
  ylab("")+xlab("Year")+
  scale_x_continuous(breaks = seq(1000, 2000, by = 2)) +
  scale_y_continuous(breaks = seq(0, 22000, by = 200)) +
  theme_hsci_discrete() +
  theme(legend.position="bottom")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  theme(plot.title = element_text(hjust = 0.5))
```
