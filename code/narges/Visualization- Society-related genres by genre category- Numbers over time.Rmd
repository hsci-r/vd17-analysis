---
title: "FBS analysis"
output:
  html_notebook:
    code_folding: hide
    toc: yes
---

```{r setup,echo=F}
knitr::opts_knit$set(root.dir = here::here())
library(here)
source("/Users/azizinar/Documents/GitHub/vd17-analysis/code/common_basis.R", local = knitr::knit_global())
library(tidyverse)
library(gghsci)
library(gt)
p <- function(number) {
  return(format(number, scientific = FALSE, big.mark = ","))
}
pp <- function(percentage, accuracy = 0.01) {
  return(scales::percent(percentage, accuracy = accuracy))
}
```

```{r}
#fbs_records_a
```

```{r}
fbs_links_a <- select(fbs_links_a,-c('method'))
```

```{r}
fbs_records <- fbs_records_a %>% inner_join(vd17_id_a) %>% inner_join(fbs_links_a, by=('record_number')) %>%
  inner_join(fbs_metadata_a%>% select(GND,member_number,First_name_new,Last_name_new,Estimated_admission_year))%>%
  mutate(first_name=First_name_new,last_name=Last_name_new,admission_year=Estimated_admission_year)%>%
  collect()%>%
  select('record_number','vd17_id','member_number','method','set','first_name','last_name','admission_year')
```

```{r}
genre_list1_a <- c("Lyrik","Lyric Poetry","Ballade","Elegie","Epigramm","Epikedeion","Figurengedicht","Gesangbuch","Lied","Kirchenlied","Liedersammlung")
genre_list1_b <- c("Drama","Theatre","Fastnachtspiel","Komödie","Märtyrerdrama","Schauspiel","Schwank","Tragödie")
genre_list1_c <- c("Epik","Prose","Anekdote","Autobiographie","Biographie","Epos","Erlebnisbericht","Erzählung","Erzählsammlung","Fabel","Märchen","Novelle","Reisebericht","Roman","Sage","Satire","Tagebuch","Verserzählung")
genre_list1_d <- c("Other Literature Related","Content Related","Schäferdichtung","Libretto","Erotische Literatur","Emblembuch","Porträtwerk","Theaterzettel","Content Neutral","Almanach","Anthologie","Kommentar:lit.","Rezension","Rezensionszeitschrift")
genre_list1_e <- c("Linguistic and Language","Grammatik","Konkordanz","Lexikon","Poetik","Rhetorik","Sprachführer","Wörterbuch","Epistolography","Briefsteller","Formularsammlung","Schreibmeisterbuch")
genre_list1_f <- c("Virtue, Civility and Ethics","Aphorismus","Anstandsliteratur","Enzyklopädie","Frauenliteratur","Fürstenspiegel","Hausväterliteratur","Jugendbuch","Kochbuch","Moralische Wochenschrift","Spiel","Sprichwortsammlung","Zitatensammlung")
genre_list1_g <- c("Other Society Related","Gesellschaftsschrift","Akademieschrift")
genre_list1_h <- c("Occasional Literature","Funeral Sermons","Leichenpredigt","Leichenpredigtsammlung","Festbeschreibung","Gelegenheitsschrift")
genre_list1_i <- c("German as a scientific language","History, Archaeology and related","Archäologie","Altertumskunde","Chronik","Genealogie","Wappenbuch","Botany, Zoology, Agriculture","Botanik","Gartenbau","Jagdliteratur","Landwirtschaft","Praktik","Pflanzenbuch","Tierbuch","Zoologie","Geography, Geology, Mineralogy, Mining","Bergbau","Geographie","Geologie","Mineralogie","Reiseführer","Topographie","Mathematics, Natural Sciences, Astronomy","Alchemie","Astronomie","Astrologie","Chemie","Physik","Akustik","Magnetismus","Mechanik","Optik","Geometrie","Mathematik","Medicine, Pharmacy","Anatomie","Arzneibuch","Chiromantie","Chirurgie","Gynäkologie","Medizin","Pharmakopöe","Physiognomie","Seuchenschrift","Tiermedizin","Architecture, Music, Arts","Musikbuch","Musiknoten","Architektur","Ornamentstich","Education","Pädagogik")
```

```{r}
vd17_normalized_years_local <- vd17_normalized_years_a %>%
  collect()
```


```{r}
vd17_genres_local <- vd17_genres_a %>%
  collect()%>%
  select(record_number,genre)

genre_cat1 <- vd17_genres_local%>%
  filter(grepl(paste(c(genre_list1_a,genre_list1_b,genre_list1_c,genre_list1_d,genre_list1_e,genre_list1_f,genre_list1_g,genre_list1_h,genre_list1_i),collapse="|"), genre))%>%
  select(record_number,genre)
```

```{r}
core_society <- fbs_records %>%
  filter(set=="Society-contributed and society-purpose related")
society_interest <- fbs_records %>%
  filter(set=="Society-contributed")
```

```{r}
vd17_normalized_langs_local <- vd17_normalized_langs_a %>%
  collect()%>%
  filter(publication_language=="ger")
```

# Visualization: Overall output of Society members in German: Numbers over time
```{r}
fbs_german <- fbs_records %>%
  inner_join(vd17_normalized_langs_local, by=c("record_number"))%>%
  left_join(vd17_normalized_years_local, by = c("record_number")) %>%
  filter(normalized_year >= 1600, normalized_year <= 1700) %>%
  filter(nchar(normalized_year)==4)%>%
  select(record_number,normalized_year,vd17_id)%>%
  group_by(normalized_year) %>%
  summarize(records = n_distinct(record_number), .groups = "drop") %>%
  mutate(phase = case_when(
    normalized_year < 1617 ~ "< 1617",
    normalized_year >= 1617 & normalized_year <= 1650 ~ "phase 1",
    normalized_year >= 1651 & normalized_year <= 1667 ~ "phase 2",
    normalized_year >= 1668 & normalized_year <= 1682 ~ "phase 3",
    normalized_year > 1682 ~ "> 1682"
  ))%>%
  distinct()

group.colors <- c("< 1617" = "grey", "phase 1" = "cyan", "phase 2" ="#9633FF", "phase 3" = "pink", "> 1682" = "grey")
fbs_german%>%
  ggplot(aes(x=normalized_year, y=records, fill = phase)) + 
  geom_col()+
  xlab("Year") + ylab("")+
  ggtitle("Member Publications in German")+
  scale_x_continuous(breaks = seq(1000, 2000, by = 2))+
  scale_y_continuous(breaks = seq(0, 500, by = 50))+
  theme_hsci_discrete()+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  theme(plot.title = element_text(hjust = 0.5))+
  scale_fill_manual(values=group.colors)

```

# Visualization: Overall output of Society members in German: Average output by member over time
# Considering 5 years prior to admission_year
```{r}
fbs_records_german <- fbs_records %>%
  inner_join(vd17_normalized_langs_local, by=c("record_number"))%>%
  left_join(vd17_normalized_years_local, by = c("record_number")) %>%
  filter(normalized_year >= 1600, normalized_year <= 1700) %>%
  filter(nchar(normalized_year)==4)%>%
  select(record_number,normalized_year,vd17_id,member_number,admission_year)

fbs_records_5 <-fbs_records_german%>%
  filter(admission_year>=(normalized_year-5))%>%
  with(aggregate(member_number ~ normalized_year,FUN=function(x){length(unique(x))}))%>%
  mutate(n_active_members=member_number)%>%
  select(n_active_members,normalized_year)

fbs_records_german_5 <- fbs_records_german %>% 
  left_join(fbs_records_5,by=c("normalized_year"))%>%
  distinct()
  
number_year_5 <- fbs_records_german_5 %>%
  group_by(normalized_year,n_active_members) %>%
  summarize(number_pub = n_distinct(record_number), .groups = "drop")

number_year_5$average_output=round(number_year_5$number_pub / number_year_5$n_active_members)
number_year_5$number_of_years_prior_to_admission="5"

number_year_5 <- number_year_5 %>%
  distinct()
```

# Considering 10 years prior to admission_year
```{r}

fbs_records_10 <-fbs_records_german%>%
  filter(admission_year>=(normalized_year-10))%>%
  with(aggregate(member_number ~ normalized_year,FUN=function(x){length(unique(x))}))%>%
  mutate(n_active_members=member_number)%>%
  select(n_active_members,normalized_year)

fbs_records_german_10 <- fbs_records_german %>% 
  left_join(fbs_records_10,by=c("normalized_year"))%>%
  distinct()
  
number_year_10 <- fbs_records_german_10 %>%
  group_by(normalized_year,n_active_members) %>%
  summarize(number_pub = n_distinct(record_number), .groups = "drop")

number_year_10$average_output=round(number_year_10$number_pub / number_year_10$n_active_members)
number_year_10$number_of_years_prior_to_admission="10"

number_year_10 <- number_year_10 %>%
  distinct()
```

# Considering 20 years prior to admission_year
```{r}

fbs_records_20 <-fbs_records_german%>%
  filter(admission_year>=(normalized_year-20))%>%
  with(aggregate(member_number ~ normalized_year,FUN=function(x){length(unique(x))}))%>%
  mutate(n_active_members=member_number)%>%
  select(n_active_members,normalized_year)

fbs_records_german_20 <- fbs_records_german %>% 
  left_join(fbs_records_20,by=c("normalized_year"))%>%
  distinct()
  
number_year_20 <- fbs_records_german_20 %>%
  group_by(normalized_year,n_active_members) %>%
  summarize(number_pub = n_distinct(record_number), .groups = "drop")

number_year_20$average_output=round(number_year_20$number_pub / number_year_20$n_active_members)
number_year_20$number_of_years_prior_to_admission="20"

number_year_20 <- number_year_20 %>%
  distinct()
```

```{r}
avg_number_per_year <- rbind(number_year_5,number_year_10,number_year_20)

```

```{r}
avg_number_per_year%>%
  ggplot(aes(x=normalized_year,y=average_output,fill=number_of_years_prior_to_admission))+
  geom_col()+
  ggtitle("Average Number of Member Publications in German")+
  xlab("") + ylab("")+
  scale_x_continuous(breaks = seq(1000, 2000, by = 2))+
  scale_y_continuous(breaks = seq(0, 150, by = 10))+
  theme_hsci_discrete()+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
```
# Visualization: Society-related genres by genre category: Numbers over time
```{r}
core_society_genre <- core_society %>%
  left_join(vd17_normalized_years_local, by = c("record_number")) %>%
  filter(normalized_year >= 1600, normalized_year <= 1700) %>%
  filter(nchar(normalized_year)==4)%>%
  inner_join(genre_cat1,by = c("record_number"))%>%
  select(record_number,normalized_year,vd17_id,genre)%>%
  mutate(genre_category = case_when(
    (grepl(paste(genre_list1_a, collapse="|"), genre)) ~ "Lyrik/Poetry",
    (grepl(paste(genre_list1_b, collapse="|"), genre)) ~ "Drama/Theatre",
    (grepl(paste(genre_list1_c, collapse="|"), genre)) ~ "Epik/Prose",
    (grepl(paste(genre_list1_d, collapse="|"), genre)) ~ "Other Literature Related",
    (grepl(paste(genre_list1_e, collapse="|"), genre)) ~ "Linguistic and Language",
    (grepl(paste(genre_list1_f, collapse="|"), genre)) ~ "Virtue, Civility and Ethics",
    (grepl(paste(genre_list1_g, collapse="|"), genre)) ~ "Other Society Related",
    (grepl(paste(genre_list1_h, collapse="|"), genre)) ~ "Occasional Literature",
    (grepl(paste(genre_list1_i, collapse="|"), genre)) ~ "German as a scientific language"
  ))%>%
  distinct()

society_interest_genre <- society_interest %>%
  left_join(vd17_normalized_years_local, by = c("record_number")) %>%
  filter(normalized_year >= 1600, normalized_year <= 1700) %>%
  filter(nchar(normalized_year)==4)%>%
  inner_join(genre_cat1,by = c("record_number"))%>%
  select(record_number,normalized_year,vd17_id,genre)%>%
  mutate(genre_category = case_when(
    (grepl(paste(genre_list1_a, collapse="|"), genre)) ~ "Lyrik/Poetry",
    (grepl(paste(genre_list1_b, collapse="|"), genre)) ~ "Drama/Theatre",
    (grepl(paste(genre_list1_c, collapse="|"), genre)) ~ "Epik/Prose",
    (grepl(paste(genre_list1_d, collapse="|"), genre)) ~ "Other Literature Related",
    (grepl(paste(genre_list1_e, collapse="|"), genre)) ~ "Linguistic and Language",
    (grepl(paste(genre_list1_f, collapse="|"), genre)) ~ "Virtue, Civility and Ethics",
    (grepl(paste(genre_list1_g, collapse="|"), genre)) ~ "Other Society Related",
    (grepl(paste(genre_list1_h, collapse="|"), genre)) ~ "Occasional Literature",
    (grepl(paste(genre_list1_i, collapse="|"), genre)) ~ "German as a scientific language"
  ))%>%
  distinct()
```

```{r}
plot1 <-core_society_genre%>%
  ggplot(aes(x=normalized_year,fill=genre_category)) +
  geom_bar(width=1) +
  labs(fill=NULL) +
  ggtitle("Member Publications in Society-Related Genre Categories (core_society)")+
  ylab("")+xlab("Year")+
  scale_x_continuous(breaks = seq(1000, 2000, by = 2)) +
  scale_y_continuous(breaks = seq(0, 500, by = 50)) +
  theme_hsci_discrete() +
  theme(legend.position="bottom")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  theme(plot.title = element_text(hjust = 0.5))

plot2 <-society_interest_genre%>%
  ggplot(aes(x=normalized_year,fill=genre_category)) +
  geom_bar(width=1) +
  labs(fill=NULL) +
  ggtitle("Member Publications in Society-Related Genre Categories (links_of_interest)")+
  ylab("")+xlab("Year")+
  scale_x_continuous(breaks = seq(1000, 2000, by = 2)) +
  scale_y_continuous(breaks = seq(0, 500, by = 50)) +
  theme_hsci_discrete() +
  theme(legend.position="bottom")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  theme(plot.title = element_text(hjust = 0.5))

ggarrange(plot1,plot2,nrow = 2,ncol = 1)

```

# Visualization: Society-related genres by genre category: Proportion over time

```{r}
core_society_frequency <- core_society_genre%>%
  filter(!(is.na(genre)))%>%
  select(vd17_id,record_number,normalized_year,genre)%>%
  distinct(vd17_id,record_number,normalized_year,genre)%>%
  group_by(normalized_year) %>%
  count(genre)%>%
  arrange(desc(n))%>%
   mutate(genre_category = case_when(
    (grepl(paste(genre_list1_a, collapse="|"), genre)) ~ "Lyrik/Poetry",
    (grepl(paste(genre_list1_b, collapse="|"), genre)) ~ "Drama/Theatre",
    (grepl(paste(genre_list1_c, collapse="|"), genre)) ~ "Epik/Prose",
    (grepl(paste(genre_list1_d, collapse="|"), genre)) ~ "Other Literature Related",
    (grepl(paste(genre_list1_e, collapse="|"), genre)) ~ "Linguistic and Language",
    (grepl(paste(genre_list1_f, collapse="|"), genre)) ~ "Virtue, Civility and Ethics",
    (grepl(paste(genre_list1_g, collapse="|"), genre)) ~ "Other Society Related",
    (grepl(paste(genre_list1_h, collapse="|"), genre)) ~ "Occasional Literature",
    (grepl(paste(genre_list1_i, collapse="|"), genre)) ~ "German as a scientific language"
  ))%>%
  distinct()

society_interest_frequency <- society_interest_genre%>%
  filter(!(is.na(genre)))%>%
  select(vd17_id,record_number,normalized_year,genre)%>%
  distinct(vd17_id,record_number,normalized_year,genre)%>%
  group_by(normalized_year) %>%
  count(genre)%>%
  arrange(desc(n))%>%
   mutate(genre_category = case_when(
    (grepl(paste(genre_list1_a, collapse="|"), genre)) ~ "Lyrik/Poetry",
    (grepl(paste(genre_list1_b, collapse="|"), genre)) ~ "Drama/Theatre",
    (grepl(paste(genre_list1_c, collapse="|"), genre)) ~ "Epik/Prose",
    (grepl(paste(genre_list1_d, collapse="|"), genre)) ~ "Other Literature Related",
    (grepl(paste(genre_list1_e, collapse="|"), genre)) ~ "Linguistic and Language",
    (grepl(paste(genre_list1_f, collapse="|"), genre)) ~ "Virtue, Civility and Ethics",
    (grepl(paste(genre_list1_g, collapse="|"), genre)) ~ "Other Society Related",
    (grepl(paste(genre_list1_h, collapse="|"), genre)) ~ "Occasional Literature",
    (grepl(paste(genre_list1_i, collapse="|"), genre)) ~ "German as a scientific language"
  ))%>%
  distinct()


p1 <-core_society_frequency%>%
  ggplot(aes(x=normalized_year,y=n,fill=genre_category)) +
  geom_col(width=1,position='fill')+
  labs(fill=NULL) +
  ggtitle("Member Publications in Society-Related Genres (core_society)")+
  ylab("")+xlab("Year")+
  scale_x_continuous(breaks = seq(1000, 2000, by = 2))+
  scale_y_continuous(labels=scales::percent_format(accuracy=1),breaks = seq(0, 1, by = 0.1)) +
  theme_hsci_discrete()+
  theme(legend.position = "bottom")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  theme(plot.title = element_text(hjust = 0.5))

p2 <-society_interest_frequency%>%
  ggplot(aes(x=normalized_year,y=n,fill=genre_category)) +
  geom_col(width=1,position='fill')+
  labs(fill=NULL) +
  ggtitle("Member Publications in Society-Related Genres (links_of_interest)")+
  ylab("")+xlab("Year")+
  scale_x_continuous(breaks = seq(1000, 2000, by = 2))+
  scale_y_continuous(labels=scales::percent_format(accuracy=1),breaks = seq(0, 1, by = 0.1)) +
  theme_hsci_discrete()+
  theme(legend.position = "bottom")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  theme(plot.title = element_text(hjust = 0.5))

ggarrange(p1,p2,nrow = 2,ncol = 1)
```

# Visualization: Comparison with VD17: Society-related genre categories
```{r}
vd17_local_id <- vd17_id_a%>%
  collect()
genres_vd17_society <- vd17_local_id %>%
  inner_join(vd17_normalized_langs_local, by=c("record_number"))%>%
  left_join(vd17_normalized_years_local, by = c("record_number")) %>%
  filter(normalized_year >= 1600, normalized_year <= 1700) %>%
  filter(nchar(normalized_year)==4)%>%
  inner_join(genre_cat1,by = c("record_number"))%>%
  select(record_number,normalized_year,vd17_id,genre)%>%
  mutate(genre_category = case_when(
    (grepl(paste(genre_list1_a, collapse="|"), genre)) ~ "Lyrik/Poetry",
    (grepl(paste(genre_list1_b, collapse="|"), genre)) ~ "Drama/Theatre",
    (grepl(paste(genre_list1_c, collapse="|"), genre)) ~ "Epik/Prose",
    (grepl(paste(genre_list1_d, collapse="|"), genre)) ~ "Other Literature Related",
    (grepl(paste(genre_list1_e, collapse="|"), genre)) ~ "Linguistic and Language",
    (grepl(paste(genre_list1_f, collapse="|"), genre)) ~ "Virtue, Civility and Ethics",
    (grepl(paste(genre_list1_g, collapse="|"), genre)) ~ "Other Society Related",
    (grepl(paste(genre_list1_h, collapse="|"), genre)) ~ "Occasional Literature",
    (grepl(paste(genre_list1_i, collapse="|"), genre)) ~ "German as a scientific language"
  ))%>%
  distinct()

genres_vd17_society%>%
  ggplot(aes(x=normalized_year,fill=genre_category)) +
  geom_bar(width=1) +
  labs(fill=NULL) +
  ggtitle("Seventeenth-Century Publications in Society-Related Genres")+
  ylab("")+xlab("Year")+
  scale_x_continuous(breaks = seq(1000, 2000, by = 2)) +
  scale_y_continuous(breaks = seq(0, 22000, by = 200)) +
  theme_hsci_discrete() +
  theme(legend.position="bottom")+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  theme(plot.title = element_text(hjust = 0.5))
```
# Visualization: Comparison with VD17: Society output in German
```{r}
vd17_fbs <- vd17_normalized_langs_local%>%
  left_join(vd17_normalized_years_local, by = c("record_number")) %>%
  filter(normalized_year >= 1600, normalized_year <= 1700) %>%
  filter(nchar(normalized_year)==4)%>%
  left_join(fbs_records,by=c('record_number')) %>%
  select ('normalized_year','record_number','vd17_id','member_number')%>%
   mutate(group = case_when(
    (is.na(member_number)) ~ "VD17",
    (!is.na(member_number)) ~ "Society"
  ))%>%
  distinct()%>%
  group_by(normalized_year) %>%
  count(group)%>%
  arrange(desc(n))


vd17_fbs%>%
  ggplot(aes(x=normalized_year,y=n,fill=group))+
  geom_col()+
  ggtitle("Seventeenth-Century Publications in German")+
  xlab("") + ylab("")+
  scale_x_continuous(breaks = seq(1000, 2000, by = 5))+
  scale_y_continuous(breaks = seq(0, 10000, by = 500))+
  theme_hsci_discrete()+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
```