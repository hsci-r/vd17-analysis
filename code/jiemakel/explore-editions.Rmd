---
title: "VD17 master link data evaluation"
output:
  html_notebook:
    code_folding: hide
    toc: yes
  md_document:
    variant: gfm
    toc: yes
---

```{r setup,echo=F}
source(here::here("code/common_basis.R"), local = knitr::knit_global())
```

## Multi-part exploration

Field 002@ (0500) - Bibliographic type and status. The 0500 field contains encoded information about the physical form, the appearance of the resource present, and the status of the record.
In the VD 17 only printed resources are recorded after autopsy. Subfield: $0 (none) - Bibliographic type and status

The following codes are possible at the respective positions. The coded information in field 0500 are given as a line without further separators:
Position 1: Physical form

* A - Print

Position 2: Bibliographic publication type

* a - Individual unit [monograph]
* c - Record covering an entire multi-part monograph
* f - Unit of a multi-part monograph/part of a monographic series with dependent titles or without title
* F Part of a multi-part monograph with a separate/independent title

Position 3: Status

* u - Autopsie

For example:

 * 0500 Aau - Note: Printed resource, individual unit, autopsy
 * 0500 Acu - Note: Printed resource, complete recording of a multi-part monograph, autopsy
 * 0500 AFu - Note: Printed resource, part of a multi-part separately/independently titled monograph, autopsy
 * 0500 Afu - Note: Printed resource, part of a multi-part monograph with dependent title, autopsy

Actual data spread in VD17:
```{r multi_part_exploration}
t <- vd17_a %>%
  filter(field_code == "002@") %>%
  count(value) %>%
  arrange(desc(n))

if (is_html_output()) {
  t %>% gt(rowname_col = "value")
} else {
  knitr::kable(t %>% collect())
}
```

```{r}
vd17_n_records <- vd17_a %>%
  distinct(record_number) %>%
  count() %>%
  pull(n)
filtered_n_records <- vd17_a %>%
  filter(field_code == "002@", !str_detect(value, "^A[ac]")) %>%
  distinct(record_number) %>%
  count() %>%
  pull(n)
```


Filtering for individual units/complete recordings (`a/c`) removes `r p(filtered_n_records)` (`r pp(filtered_n_records/vd17_n_records)`) out of the `r p(vd17_n_records)` original records.

## Variant exploration

```{r}
extents <- vd17_a %>%
  filter(field_code == "034D") %>%
  distinct(record_number, extent = value) %>%
  group_by(record_number) %>%
  dbplyr::window_order(extent) %>%
  summarize(extents = str_flatten(extent, collapse = "|"), .groups = "drop") %>%
  collect() %>%
  copy_to_c(con)

form_factors <- vd17_a %>%
  filter(field_code == "034I") %>%
  distinct(record_number, form_factor = value) %>%
  group_by(record_number) %>%
  dbplyr::window_order(extent) %>%
  summarize(form_factors = str_flatten(form_factor, collapse = "|"), .groups = "drop") %>%
  collect() %>%
  copy_to_c(con)

places_of_publication <- vd17_normalized_locations_a %>%
  filter(location_type == "pup") %>%
  select(record_number, place_of_publication = location)
places_of_production <- vd17_normalized_locations_a %>%
  filter(location_type == "mfp") %>%
  select(record_number, place_of_production = location)
places_of_distribution <- vd17_normalized_locations_a %>%
  filter(location_type == "dbp") %>%
  select(record_number, place_of_distribution = location)

unified_places_of_publication <- vd17_a %>%
  distinct(record_number) %>%
  left_join(places_of_publication) %>%
  left_join(places_of_production) %>%
  left_join(places_of_distribution) %>%
  mutate(place_of_publication = coalesce(place_of_publication, place_of_production, place_of_distribution)) %>%
  filter(!is.na(place_of_publication)) %>%
  distinct(record_number, place_of_publication) %>%
  group_by(record_number) %>%
  dbplyr::window_order(place_of_publication) %>%
  summarize(places_of_publication = str_flatten(place_of_publication, collapse = "|"), .groups = "drop") %>%
  collect() %>%
  copy_to_c(con)

rda_printers <- vd17_a %>%
  filter(field_code == "029F", subfield_code == "4", value == "prt") %>%
  select(record_number, field_number) %>%
  inner_join(vd17_a %>% filter(subfield_code == "7")) %>%
  select(record_number, printer_gnd = value)
printers <- vd17_a %>%
  filter(field_code == "033J", subfield_code == "7") %>%
  select(record_number, printer_gnd = value)
additional_printers <- vd17_a %>%
  filter(field_code == "028C", (subfield_code == "4" & value == "prt") | (subfield_code == "B" & str_detect(value, "^Drucker|^Verleger"))) %>%
  distinct(record_number, field_number) %>%
  inner_join(vd17_a %>% filter(subfield_code == "7")) %>%
  select(record_number, printer_gnd = value)
all_printers <- rda_printers %>%
  union_all(printers) %>%
  union_all(additional_printers) %>%
  distinct(record_number, printer_gnd) %>%
  group_by(record_number) %>%
  dbplyr::window_order(printer_gnd) %>%
  summarize(printer_gnds = str_flatten(printer_gnd, collapse = "|"), .groups = "drop") %>%
  collect() %>%
  copy_to_c(con)
```

```{r}
vd17_identical_titles <- vd17_titles_c %>%
  select(record_number, title) %>%
  inner_join(vd17_titles_c %>% select(record_number, title), sql_on = "LHS.title=RHS.title AND LHS.record_number<RHS.record_number") %>%
  select(record_number.x, record_number.y, title = title.x) %>%
  compute_a()

identical_title_removal_removes_n <-
  vd17_identical_titles %>%
  select(record_number = record_number.x) %>%
  union_all(
    vd17_identical_titles %>%
      select(record_number = record_number.y)
  ) %>%
  distinct() %>%
  count() %>%
  pull(n) - (vd17_identical_titles %>% distinct(title) %>% count() %>% pull(n))

t <- vd17_titles_c %>%
  select(record_number, title) %>%
  inner_join(vd17_normalized_years_c %>% select(record_number, normalized_year))

vd17_identical_titles_and_years <- t %>%
  inner_join(t, sql_on = "LHS.title=RHS.title AND LHS.normalized_year=RHS.normalized_year AND LHS.record_number<RHS.record_number") %>%
  select(record_number.x, record_number.y, title = title.x, normalized_year = normalized_year.x) %>%
  compute_a()

identical_title_and_year_removal_removes_n <-
  vd17_identical_titles_and_years %>%
  select(record_number = record_number.x) %>%
  union_all(
    vd17_identical_titles_and_years %>%
      select(record_number = record_number.y)
  ) %>%
  distinct() %>%
  count() %>%
  pull(n) - (vd17_identical_titles_and_years %>% distinct(title, normalized_year) %>% count() %>% pull(n))

t <- vd17_titles_c %>%
  select(record_number, title) %>%
  inner_join(vd17_normalized_years_c %>% select(record_number, normalized_year)) %>%
  inner_join(unified_places_of_publication)

vd17_identical_titles_and_years_and_places_of_publication <- t %>%
  inner_join(t, sql_on = "LHS.title=RHS.title AND LHS.normalized_year=RHS.normalized_year AND LHS.places_of_publication=RHS.places_of_publication AND LHS.record_number<RHS.record_number") %>%
  select(record_number.x, record_number.y, title = title.x, normalized_year = normalized_year.x, places_of_publication = places_of_publication.x) %>%
  compute_a()

identical_title_and_year_and_place_of_publication_removal_removes_n <-
  vd17_identical_titles_and_years_and_places_of_publication %>%
  select(record_number = record_number.x) %>%
  union_all(
    vd17_identical_titles_and_years_and_places_of_publication %>%
      select(record_number = record_number.y)
  ) %>%
  distinct() %>%
  count() %>%
  pull(n) - (vd17_identical_titles_and_years_and_places_of_publication %>% distinct(title, normalized_year, places_of_publication) %>% count() %>% pull(n))

t <- vd17_titles_c %>%
  select(record_number, title) %>%
  inner_join(vd17_normalized_years_c %>% select(record_number, normalized_year)) %>%
  inner_join(all_printers)

vd17_identical_titles_and_years_and_printers <- t %>%
  inner_join(t, sql_on = "LHS.title=RHS.title AND LHS.normalized_year=RHS.normalized_year AND LHS.printer_gnds=RHS.printer_gnds AND LHS.record_number<RHS.record_number") %>%
  select(record_number.x, record_number.y, title = title.x, normalized_year = normalized_year.x, printer_gnds = printer_gnds.x) %>%
  compute_a()

identical_title_and_year_and_printer_removal_removes_n <-
  vd17_identical_titles_and_years_and_printers %>%
  select(record_number = record_number.x) %>%
  union_all(
    vd17_identical_titles_and_years_and_printers %>%
      select(record_number = record_number.y)
  ) %>%
  distinct() %>%
  count() %>%
  pull(n) - (vd17_identical_titles_and_years_and_printers %>% distinct(title, normalized_year, printer_gnds) %>% count() %>% pull(n))

t <- vd17_titles_c %>%
  select(record_number, title) %>%
  inner_join(vd17_normalized_years_c %>% select(record_number, normalized_year)) %>%
  inner_join(unified_places_of_publication) %>%
  inner_join(all_printers)

vd17_identical_titles_and_years_and_places_of_publication_and_printers <- t %>%
  inner_join(t, sql_on = "LHS.title=RHS.title AND LHS.normalized_year=RHS.normalized_year AND LHS.places_of_publication=RHS.places_of_publication AND LHS.printer_gnds=RHS.printer_gnds AND LHS.record_number<RHS.record_number") %>%
  select(record_number.x, record_number.y, title = title.x, normalized_year = normalized_year.x, places_of_publication = places_of_publication.x, printer_gnds = printer_gnds.x) %>%
  compute_a()

identical_title_and_year_and_place_of_publication_and_printer_removal_removes_n <-
  vd17_identical_titles_and_years_and_places_of_publication_and_printers %>%
  select(record_number = record_number.x) %>%
  union_all(
    vd17_identical_titles_and_years_and_places_of_publication_and_printers %>%
      select(record_number = record_number.y)
  ) %>%
  distinct() %>%
  count() %>%
  pull(n) - (vd17_identical_titles_and_years_and_places_of_publication_and_printers %>% distinct(title, normalized_year, places_of_publication, printer_gnds) %>% count() %>% pull(n))

t <- vd17_titles_c %>%
  select(record_number, title) %>%
  inner_join(vd17_normalized_years_c %>% select(record_number, normalized_year)) %>%
  inner_join(unified_places_of_publication) %>%
  inner_join(all_printers) %>%
  inner_join(extents) %>%
  inner_join(form_factors)

vd17_identical_all <- t %>%
  inner_join(t, sql_on = "LHS.title=RHS.title AND LHS.normalized_year=RHS.normalized_year AND LHS.places_of_publication=RHS.places_of_publication AND LHS.printer_gnds=RHS.printer_gnds AND LHS.extents=RHS.extents AND LHS.form_factors=RHS.form_factors AND LHS.record_number<RHS.record_number") %>%
  select(record_number.x, record_number.y, title = title.x, normalized_year = normalized_year.x, places_of_publication = places_of_publication.x, printer_gnds = printer_gnds.x, extents = extents.x, form_factors = form_factors.x) %>%
  compute_a()

identical_all_removal_removes_n <-
  vd17_identical_all %>%
  select(record_number = record_number.x) %>%
  union_all(
    vd17_identical_all %>%
      select(record_number = record_number.y)
  ) %>%
  distinct() %>%
  count() %>%
  pull(n) - (vd17_identical_all %>% distinct(title, normalized_year, places_of_publication, printer_gnds, extents, form_factors) %>% count() %>% pull(n))
```

Filtering out records with identical:

 * titles would remove `r p(identical_title_removal_removes_n)` (`r pp(identical_title_removal_removes_n/vd17_n_records)`) records out of the `r p(vd17_n_records)` original records.
 * titles and publication years would remove `r p(identical_title_and_year_removal_removes_n)` (`r pp(identical_title_and_year_removal_removes_n/vd17_n_records)`) records out of the `r p(vd17_n_records)` original records.
 * titles, publication years and places of publication would remove `r p(identical_title_and_year_and_place_of_publication_removal_removes_n)` (`r pp(identical_title_and_year_and_place_of_publication_removal_removes_n/vd17_n_records)`) records out of the `r p(vd17_n_records)` original records.
 * titles, publication years and printers would remove `r p(identical_title_and_year_and_printer_removal_removes_n)` (`r pp(identical_title_and_year_and_printer_removal_removes_n/vd17_n_records)`) records out of the `r p(vd17_n_records)` original records.
 * titles, publication years, places of publication and printers would remove `r p(identical_title_and_year_and_place_of_publication_and_printer_removal_removes_n)` (`r pp(identical_title_and_year_and_place_of_publication_and_printer_removal_removes_n/vd17_n_records)`) records out of the `r p(vd17_n_records)` original records.
 * titles, publication years, places of publication, printers, extents and form factors would remove `r p(identical_all_removal_removes_n)` (`r pp(identical_all_removal_removes_n/vd17_n_records)`) records out of the `r p(vd17_n_records)` original records.


## Variant ground truth creation

You could find lots of variants simply by looking for records with "nicht identisch" in field 037A, and then I could choose some to create ground truth groupings from. I hope we can avoid messing with the extent using this and, if necessary, the fingerprints.

Should have lots of variants:

* Kleopatra
* Schach oder König-Spiel
* New erfundenes and vollständiges Trenchir-Büchlein
* Cornelius Nepos

## Multi-volume work and variant interaction

Multi-volume works that should also have variants:

I can give you the few from my earlier comparison, or you could generate a more random set based on the codes for parts of multi-volume works and note contains "ident", whichever you think will work better

Here they are:

 * Der Grosse SchauPlatz Jämerlicher Mordgeschichte
 * Der Römischen Keyser
 * Der Teutsche Secretarius
